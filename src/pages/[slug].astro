---
// src/pages/[slug].astro
import BaseLayout from '@layouts/BaseLayout.astro';
import Breadcrumb from '@components/common/Breadcrumb.astro';
import TableOfContents from '@components/article/TableOfContents.astro';
import AuthorCard from '@components/article/AuthorCard.astro';
import RelatedArticles from '@components/article/RelatedArticles.astro';
import SidebarAuthor from '@components/article/SidebarAuthor.astro';
import SidebarProducts from '@components/article/SidebarProducts.astro';
import SidebarRelated from '@components/article/SidebarRelated.astro';
import Newsletter from '@components/common/Newsletter.astro';
import { generateArticleSchema, generateBreadcrumbSchema, generateFAQSchema } from '@lib/seo';
import { marked } from 'marked';
import { db } from '@lib/db';
import { articles, authors } from '@lib/db/schema';
import { eq, desc } from 'drizzle-orm';

export const prerender = false;

// 配置 marked 选项
marked.setOptions({
  breaks: true,
  gfm: true,
});

// 自定义渲染器 - 为标题添加 id，为表格添加滚动容器
const renderer = new marked.Renderer();
renderer.heading = ({ depth, text }) => {
  const slug = text.toLowerCase().replace(/[^a-z0-9]+/g, '-');
  return `<h${depth} id="${slug}">${text}</h${depth}>`;
};
renderer.table = (token) => {
  // 用 div 包裹表格，实现横向滚动
  const header = token.header.map(cell => `<th>${cell.text}</th>`).join('');
  const rows = token.rows.map(row => 
    `<tr>${row.map(cell => `<td>${cell.text}</td>`).join('')}</tr>`
  ).join('');
  return `<div class="table-wrapper" style="overflow-x:auto;margin-bottom:1.5rem"><table><thead><tr>${header}</tr></thead><tbody>${rows}</tbody></table></div>`;
};
marked.use({ renderer });

// 从数据库获取文章
const slug = Astro.params.slug;
if (!slug) {
  return Astro.redirect('/404');
}

const result = await db.select().from(articles).where(eq(articles.slug, slug));
const currentArticle = result[0];

// 如果文章不存在或未发布，返回 404
if (!currentArticle || currentArticle.status !== 'published') {
  return Astro.redirect('/404');
}

// 获取作者信息
const authorResult = currentArticle.authorId 
  ? await db.select().from(authors).where(eq(authors.id, currentArticle.authorId))
  : [];
const author = authorResult[0] || null;

// 获取相关文章
const relatedResult = await db
  .select()
  .from(articles)
  .where(eq(articles.category, currentArticle.category))
  .orderBy(desc(articles.publishedAt))
  .limit(3);
const relatedArticlesList = relatedResult.filter(a => a.slug !== currentArticle.slug && a.status === 'published');

// 渲染 Markdown 内容
const contentHtml = await marked(currentArticle.content);

const title = currentArticle.title;
const description = currentArticle.description;

// 目录生成 - 只提取 H2 和 H3
const headingMatches = currentArticle.content.match(/^##[^#].*$|^###[^#].*$/gm) || [];
const toc = headingMatches.map((h: string) => {
  const level = (h.match(/^#+/) || [''])[0].length;
  const text = h.replace(/^#+\s/, '');
  const slug = text.toLowerCase().replace(/[^a-z0-9]+/g, '-');
  return { depth: level, text, slug };
});

// 面包屑
const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: currentArticle.category, href: `/category/${currentArticle.category}` },
  { label: currentArticle.title },
];

// 格式化相关文章
const relatedArticles = relatedArticlesList.slice(0, 2).map(a => ({
  title: a.title,
  slug: a.slug,
  category: a.category,
  description: a.description,
  readingTime: a.readingTime || 5,
  publishedAt: a.publishedAt || '',
}));

// 侧边栏相关文章（更多，用于侧边栏紧凑列表）
const sidebarRelated = relatedArticlesList.slice(0, 4).map(a => ({
  title: a.title,
  slug: a.slug,
  category: a.category,
}));

// 解析作者资质
let authorCredentials = '';
let authorExpertise = '';
if (author?.credentials) authorCredentials = author.credentials;
if (author?.expertise) {
  try {
    const exp = JSON.parse(author.expertise);
    authorExpertise = Array.isArray(exp) ? exp.join(', ') : author.expertise;
  } catch {
    authorExpertise = author.expertise;
  }
}
---

<BaseLayout title={title} description={description} type="article">
  <article class="py-8 md:py-12">
    <div class="container-content">
      <!-- Breadcrumb -->
      <Breadcrumb items={breadcrumbs} />
      
      <!-- Article Header -->
      <header class="mb-10 pb-8 border-b border-gray-200 dark:border-gray-800">
        <span class="badge badge-primary capitalize mb-4">{currentArticle.category}</span>
        <h1 class="text-h1 text-gray-900 dark:text-white mb-4 text-balance">
          {currentArticle.title}
        </h1>
        <p class="text-body-l text-gray-600 dark:text-gray-400 mb-6 max-w-3xl">
          {currentArticle.description}
        </p>
        
        <!-- Meta -->
        <div class="flex flex-wrap items-center gap-4 text-body-s text-gray-500 dark:text-gray-400">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center">
              {author?.avatar ? (
                <img src={author.avatar} alt={author.name} class="w-full h-full rounded-full object-cover" />
              ) : (
                <span class="text-primary-600 dark:text-primary-400 font-medium text-caption">
                  {author?.name?.charAt(0) || 'K'}
                </span>
              )}
            </div>
            <span class="font-medium text-gray-700 dark:text-gray-300">{author?.name || 'PuraCatCare Team'}</span>
          </div>
          <span class="text-gray-300 dark:text-gray-600">·</span>
          <time datetime={currentArticle.publishedAt || ''}>
            {currentArticle.publishedAt 
              ? new Date(currentArticle.publishedAt).toLocaleDateString('en-US', { 
                  month: 'long', 
                  day: 'numeric', 
                  year: 'numeric' 
                })
              : 'Draft'
            }
          </time>
          <span class="text-gray-300 dark:text-gray-600">·</span>
          <span>{currentArticle.readingTime || 5} min read</span>
        </div>
      </header>
      
      <!-- Content Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-[1fr_280px] gap-10">
        <!-- Main Content -->
        <div class="min-w-0">
          <div class="prose dark:prose-invert max-w-none" set:html={contentHtml} />
          
          <!-- Author Card -->
          <div class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-800">
            <AuthorCard 
              name={author?.name || 'PuraCatCare Team'} 
              bio={author?.bio || 'We provide evidence-based guides on feline urinary and kidney health to help cat owners make informed decisions.'}
              avatar={author?.avatar || undefined}
            />
          </div>
          
          <!-- Related Articles -->
          {relatedArticles.length > 0 && (
            <RelatedArticles articles={relatedArticles} />
          )}
        </div>
        
        <!-- Sidebar -->
        <aside class="hidden lg:block">
          <div class="sticky top-24 space-y-6">
            <!-- Table of Contents -->
            <TableOfContents headings={toc} />
            
            <!-- Sidebar Author -->
            <SidebarAuthor
              name={author?.name || 'PuraCatCare Team'}
              bio={author?.bio || 'Evidence-based feline health content.'}
              avatar={author?.avatar || undefined}
              credentials={authorCredentials}
              expertise={authorExpertise}
            />
            
            <!-- Sidebar Products -->
            <SidebarProducts />
            
            <!-- Sidebar Related Articles -->
            <SidebarRelated articles={sidebarRelated} />
          </div>
        </aside>
      </div>
    </div>
  </article>
  
  <!-- Newsletter -->
  <Newsletter variant="compact" />
  
  <!-- Article Schema -->
  <script type="application/ld+json" set:html={JSON.stringify(
    generateArticleSchema({
      title: currentArticle.title,
      description: currentArticle.description,
      slug: currentArticle.slug,
      publishedAt: new Date(currentArticle.publishedAt || Date.now()),
      updatedAt: currentArticle.updatedAt ? new Date(currentArticle.updatedAt) : undefined,
      authorName: author?.name,
      image: currentArticle.heroImage || undefined,
    })
  )} />
  
  <!-- BreadcrumbList Schema -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify(
    generateBreadcrumbSchema([
      { name: 'Home', url: '/' },
      { name: currentArticle.category, url: `/category/${currentArticle.category}` },
      { name: currentArticle.title }
    ])
  )} />
  
  <!-- FAQ Schema -->
  {currentArticle.faqJson && (
    <script is:inline type="application/ld+json" set:html={JSON.stringify(
      generateFAQSchema(JSON.parse(currentArticle.faqJson))
    )} />
  )}
</BaseLayout>

<style>
  :global(.prose :is(h2, h3, h4)) {
    scroll-margin-top: 6rem;
  }
  
  :global(.prose) {
    color: theme('colors.gray.700');
  }
  
  :global(.dark .prose) {
    color: theme('colors.gray.300');
  }
  
  :global(.prose h2) {
    font-size: 1.5rem;
    font-weight: 700;
    color: theme('colors.gray.900');
    margin-top: 2rem;
    margin-bottom: 1rem;
  }
  
  :global(.dark .prose h2) {
    color: theme('colors.white');
  }
  
  :global(.prose h3) {
    font-size: 1.25rem;
    font-weight: 600;
    color: theme('colors.gray.900');
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }
  
  :global(.dark .prose h3) {
    color: theme('colors.white');
  }
  
  :global(.prose p) {
    margin-bottom: 1rem;
    line-height: 1.75;
  }
  
  :global(.prose ul, .prose ol) {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }
  
  :global(.prose li) {
    margin-bottom: 0.5rem;
  }
  
  :global(.prose blockquote) {
    border-left: 4px solid theme('colors.primary.500');
    padding-left: 1rem;
    font-style: italic;
    color: theme('colors.gray.600');
    margin: 1rem 0;
  }
  
  :global(.dark .prose blockquote) {
    color: theme('colors.gray.400');
  }
  
  :global(.prose strong) {
    font-weight: 600;
    color: theme('colors.gray.900');
  }
  
  :global(.dark .prose strong) {
    color: theme('colors.white');
  }
  
  :global(.prose a) {
    color: theme('colors.primary.600');
    text-decoration: underline;
  }
  
  :global(.dark .prose a) {
    color: theme('colors.primary.400');
  }
  
  :global(.prose code) {
    background-color: theme('colors.gray.100');
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
  }
  
  :global(.dark .prose code) {
    background-color: theme('colors.gray.800');
  }
  
  :global(.prose pre) {
    background-color: theme('colors.gray.900');
    color: theme('colors.gray.100');
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1rem 0;
  }
  
  :global(.prose pre code) {
    background-color: transparent;
    padding: 0;
  }
  
  /* 表格样式 — 使用 :global 确保作用于 set:html 注入的内容 */
  :global(.prose table) {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
  }
  
  :global(.prose .table-wrapper) {
    overflow-x: auto;
    margin-bottom: 1.5rem;
  }
  
  :global(.prose thead) {
    background-color: #f3f4f6;
  }
  
  :global(.dark .prose thead) {
    background-color: #374151;
  }
  
  :global(.prose th) {
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 600;
    color: #111827;
    border-bottom: 2px solid #d1d5db;
    white-space: nowrap;
  }
  
  :global(.dark .prose th) {
    color: #f9fafb;
    border-bottom-color: #4b5563;
  }
  
  :global(.prose td) {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e5e7eb;
  }
  
  :global(.dark .prose td) {
    border-bottom-color: #374151;
  }
  
  :global(.prose tbody tr:nth-child(even)) {
    background-color: #f9fafb;
  }
  
  :global(.dark .prose tbody tr:nth-child(even)) {
    background-color: #1f2937;
  }
  
  :global(.prose tbody tr:hover) {
    background-color: #f3f4f6;
  }
  
  :global(.dark .prose tbody tr:hover) {
    background-color: #374151;
  }
</style>