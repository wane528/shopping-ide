---
// src/pages/admin/media.astro
// 媒体管理

export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';

const title = '媒体管理';
---

<AdminLayout title={title}>
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">媒体库</h2>
  </div>
  
  <!-- 上传区域 -->
  <div class="admin-card mb-6">
    <div 
      id="drop-zone"
      class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center cursor-pointer hover:border-primary-500 dark:hover:border-primary-400 transition-colors"
    >
      <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
      </svg>
      <p class="text-gray-600 dark:text-gray-400 mb-2">拖拽文件到此处上传</p>
      <p class="text-sm text-gray-400">或点击选择文件（支持图片格式）</p>
      <input type="file" class="hidden" id="file-input" accept="image/*" multiple />
    </div>
    <div id="upload-progress" class="hidden mt-4">
      <div class="flex items-center gap-2">
        <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
          <div id="progress-bar" class="bg-primary-500 h-2 rounded-full transition-all" style="width: 0%"></div>
        </div>
        <span id="progress-text" class="text-sm text-gray-500">0%</span>
      </div>
    </div>
  </div>
  
  <!-- 文件列表 -->
  <div class="admin-card">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">已上传文件</h3>
    
    <div id="media-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
      <!-- 文件将通过 JS 加载 -->
    </div>
    
    <div id="empty-state" class="text-center py-12 text-gray-500 dark:text-gray-400 hidden">
      <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
      </svg>
      <p>暂无文件</p>
    </div>
  </div>
  
  <!-- 复制链接提示 -->
  <div id="copy-toast" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity pointer-events-none">
    链接已复制到剪贴板
  </div>
</AdminLayout>

<script>
  const dropZone = document.getElementById('drop-zone');
  const fileInput = document.getElementById('file-input') as HTMLInputElement;
  const mediaGrid = document.getElementById('media-grid');
  const emptyState = document.getElementById('empty-state');
  const uploadProgress = document.getElementById('upload-progress');
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');
  const copyToast = document.getElementById('copy-toast');
  
  // 加载媒体文件列表
  async function loadMediaFiles() {
    try {
      const response = await fetch('/api/admin/media');
      const data = await response.json();
      
      if (data.files && data.files.length > 0) {
        emptyState?.classList.add('hidden');
        renderMediaFiles(data.files);
      } else {
        emptyState?.classList.remove('hidden');
        if (mediaGrid) mediaGrid.innerHTML = '';
      }
    } catch (error) {
      console.error('Failed to load media files:', error);
    }
  }
  
  // 渲染媒体文件
  function renderMediaFiles(files: any[]) {
    if (!mediaGrid) return;
    
    mediaGrid.innerHTML = files.map((file) => `
      <div class="group relative border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
        <div class="aspect-square bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
          ${file.type === 'image' 
            ? `<img src="${file.url}" alt="${file.name}" class="w-full h-full object-cover" loading="lazy" />`
            : `<svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>`
          }
        </div>
        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
          <button 
            class="p-2 bg-white rounded-lg text-gray-700 hover:bg-gray-100 copy-btn"
            data-url="${file.url}"
            title="复制链接"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
          </button>
          <button 
            class="p-2 bg-white rounded-lg text-red-600 hover:bg-red-50 delete-btn"
            data-name="${file.id}"
            title="删除"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </button>
        </div>
        <div class="p-2">
          <p class="text-xs text-gray-600 dark:text-gray-400 truncate">${file.name}</p>
          <p class="text-xs text-gray-400">${file.size}</p>
        </div>
      </div>
    `).join('');
    
    // 绑定事件
    bindMediaEvents();
  }
  
  // 绑定媒体操作事件
  function bindMediaEvents() {
    // 复制链接
    document.querySelectorAll('.copy-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const url = (btn as HTMLElement).getAttribute('data-url');
        if (url) {
          await navigator.clipboard.writeText(url);
          showToast();
        }
      });
    });
    
    // 删除文件
    document.querySelectorAll('.delete-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const fileName = (btn as HTMLElement).getAttribute('data-name');
        if (fileName && confirm('确定要删除这个文件吗？')) {
          try {
            const response = await fetch('/api/admin/media', {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ fileName }),
            });
            const result = await response.json();
            if (result.success) {
              loadMediaFiles();
            } else {
              alert('删除失败：' + (result.error || '未知错误'));
            }
          } catch (error) {
            alert('删除失败，请重试。');
          }
        }
      });
    });
  }
  
  // 显示复制提示
  function showToast() {
    if (!copyToast) return;
    copyToast.classList.remove('opacity-0');
    copyToast.classList.add('opacity-100');
    setTimeout(() => {
      copyToast.classList.remove('opacity-100');
      copyToast.classList.add('opacity-0');
    }, 2000);
  }
  
  // 上传文件
  async function uploadFiles(files: FileList) {
    if (!uploadProgress || !progressBar || !progressText) return;
    
    uploadProgress.classList.remove('hidden');
    
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const progress = Math.round(((i + 1) / files.length) * 100);
      
      progressBar.style.width = `${progress}%`;
      progressText.textContent = `${progress}%`;
      
      const formData = new FormData();
      formData.append('file', file);
      
      try {
        const response = await fetch('/api/admin/media', {
          method: 'POST',
          body: formData,
        });
        const result = await response.json();
        
        if (!result.success) {
          console.error('Failed to upload:', file.name, result.error);
        }
      } catch (error) {
        console.error('Failed to upload:', file.name, error);
      }
    }
    
    // 重置进度条
    setTimeout(() => {
      uploadProgress.classList.add('hidden');
      progressBar.style.width = '0%';
      progressText.textContent = '0%';
    }, 500);
    
    // 刷新文件列表
    loadMediaFiles();
  }
  
  // 点击上传
  dropZone?.addEventListener('click', () => {
    fileInput?.click();
  });
  
  // 文件选择
  fileInput?.addEventListener('change', (e) => {
    const files = (e.target as HTMLInputElement).files;
    if (files && files.length > 0) {
      uploadFiles(files);
    }
  });
  
  // 拖拽上传
  dropZone?.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20');
  });
  
  dropZone?.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20');
  });
  
  dropZone?.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20');
    
    const files = e.dataTransfer?.files;
    if (files && files.length > 0) {
      uploadFiles(files);
    }
  });
  
  // 初始加载
  loadMediaFiles();
</script>