---
// src/pages/admin/articles/new.astro
// 新建文章页面

export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
import { db } from '@lib/db';
import { authors } from '@lib/db/schema';

const title = '新建文章';

// 分类列表
const categories = [
  { slug: 'urinary-health', name: 'Urinary Health' },
  { slug: 'kidney-disease', name: 'Kidney Disease' },
  { slug: 'reviews', name: 'Reviews' },
  { slug: 'care-tips', name: 'Care Tips' },
];

// 获取作者列表
const authorList = await db.select().from(authors);

// 检查错误消息
const errorMessage = Astro.url.searchParams.get('error');
---

<AdminLayout title={title}>
  <!-- 错误提示 -->
  {errorMessage && (
    <div class="mb-6 p-4 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-lg">
      {errorMessage === 'slug-exists' && 'URL Slug 已存在，请使用其他名称。'}
      {errorMessage === 'save-failed' && '保存失败，请重试。'}
    </div>
  )}

  <form action="/api/admin/articles" method="POST" class="max-w-4xl">
    <!-- 基本信息 -->
    <div class="admin-card mb-6">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">基本信息</h2>
      
      <div class="admin-form-group">
        <label for="title" class="admin-label">文章标题 *</label>
        <input 
          type="text" 
          id="title" 
          name="title" 
          required
          class="admin-input"
          placeholder="输入文章标题"
        />
      </div>
      
      <div class="grid grid-cols-2 gap-4">
        <div class="admin-form-group">
          <label for="slug" class="admin-label">URL Slug *</label>
          <input 
            type="text" 
            id="slug" 
            name="slug" 
            required
            class="admin-input"
            placeholder="article-url-slug"
          />
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
            文章 URL 路径，如: getting-started-guide
          </p>
        </div>
        
        <div class="admin-form-group">
          <label for="category" class="admin-label">分类 *</label>
          <select id="category" name="category" required class="admin-input">
            <option value="">选择分类</option>
            {categories.map((cat) => (
              <option value={cat.slug}>{cat.name}</option>
            ))}
          </select>
        </div>
      </div>
      
      <div class="admin-form-group">
        <label for="description" class="admin-label">文章摘要 *</label>
        <textarea 
          id="description" 
          name="description" 
          rows="3"
          required
          class="admin-input"
          placeholder="简短描述文章内容（用于 SEO 和文章卡片显示，最多 160 字符）"
          maxlength="160"
        ></textarea>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          <span id="description-count">0</span>/160 字符
        </p>
      </div>
    </div>
    
    <!-- 文章内容 -->
    <div class="admin-card mb-6">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">文章内容</h2>
      
      <div class="admin-form-group">
        <label for="content" class="admin-label">正文内容 (Markdown) *</label>
        <div class="border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden">
          <!-- 工具栏 -->
          <div class="flex items-center gap-1 p-2 bg-gray-50 dark:bg-gray-800 border-b border-gray-300 dark:border-gray-600">
            <button type="button" class="editor-btn" data-action="bold" title="粗体">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 4h8a4 4 0 014 4 4 4 0 01-4 4H6z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 12h9a4 4 0 014 4 4 4 0 01-4 4H6z"/>
              </svg>
            </button>
            <button type="button" class="editor-btn" data-action="italic" title="斜体">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 4h4m-2 0v16m-4 0h8"/>
              </svg>
            </button>
            <div class="w-px h-4 bg-gray-300 dark:bg-gray-600 mx-1"></div>
            <button type="button" class="editor-btn" data-action="h2" title="标题 2">H2</button>
            <button type="button" class="editor-btn" data-action="h3" title="标题 3">H3</button>
            <div class="w-px h-4 bg-gray-300 dark:bg-gray-600 mx-1"></div>
            <button type="button" class="editor-btn" data-action="ul" title="无序列表">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
              </svg>
            </button>
            <button type="button" class="editor-btn" data-action="ol" title="有序列表">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
              </svg>
            </button>
            <button type="button" class="editor-btn" data-action="link" title="外部链接">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
              </svg>
            </button>
            <button type="button" class="editor-btn" data-action="internal-link" title="内部链接（站内文章）">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
              </svg>
            </button>
            <button type="button" class="editor-btn" data-action="image" title="图片">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
            </button>
            <button type="button" class="editor-btn" data-action="code" title="代码块">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
              </svg>
            </button>
          </div>
          <!-- 编辑区 -->
          <textarea 
            id="content" 
            name="content" 
            rows="20"
            required
            class="w-full p-4 text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-white resize-none focus:outline-none font-mono"
            placeholder="使用 Markdown 格式编写文章内容..."
          ></textarea>
        </div>
      </div>
      
      <div class="admin-form-group">
        <label for="heroImage" class="admin-label">封面图片</label>
        <div class="flex gap-2">
          <input 
            type="text" 
            id="heroImage" 
            name="heroImage"
            class="admin-input flex-1"
            placeholder="/uploads/cover.jpg 或完整 URL"
          />
          <button type="button" id="hero-media-btn" class="admin-btn admin-btn-secondary whitespace-nowrap">
            从媒体库选择
          </button>
        </div>
        <div id="hero-preview" class="mt-2 hidden">
          <img id="hero-preview-img" src="" alt="封面预览" class="h-32 rounded-lg object-cover border border-gray-200 dark:border-gray-700" />
        </div>
      </div>
    </div>
    
    <!-- SEO 设置 -->
    <div class="admin-card mb-6">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">SEO 设置</h2>
      
      <div class="admin-form-group">
        <label for="metaTitle" class="admin-label">SEO 标题</label>
        <input 
          type="text" 
          id="metaTitle" 
          name="metaTitle"
          class="admin-input"
          placeholder="留空则使用文章标题"
          maxlength="60"
        />
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">最多 60 字符</p>
      </div>
      
      <div class="admin-form-group">
        <label for="metaDescription" class="admin-label">SEO 描述</label>
        <textarea 
          id="metaDescription" 
          name="metaDescription" 
          rows="2"
          class="admin-input"
          placeholder="留空则使用文章摘要"
          maxlength="160"
        ></textarea>
      </div>
      
      <div class="admin-form-group">
        <label for="canonical" class="admin-label">Canonical URL</label>
        <input 
          type="text" 
          id="canonical" 
          name="canonical"
          class="admin-input"
          placeholder="留空则自动生成"
        />
      </div>
    </div>
    
    <!-- 发布设置 -->
    <div class="admin-card mb-6">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">发布设置</h2>
      
      <div class="grid grid-cols-3 gap-4">
        <div class="admin-form-group">
          <label for="status" class="admin-label">状态</label>
          <select id="status" name="status" class="admin-input">
            <option value="draft">草稿</option>
            <option value="published">立即发布</option>
            <option value="scheduled">定时发布</option>
          </select>
        </div>
        
        <div class="admin-form-group">
          <label for="authorId" class="admin-label">作者</label>
          <select id="authorId" name="authorId" class="admin-input">
            {authorList.map((author) => (
              <option value={author.id}>{author.name}</option>
            ))}
          </select>
        </div>
        
        <div class="admin-form-group">
          <label for="featured" class="admin-label">推荐文章</label>
          <select id="featured" name="featured" class="admin-input">
            <option value="false">否</option>
            <option value="true">是</option>
          </select>
        </div>
      </div>
      
      <!-- 定时发布设置 -->
      <div id="scheduleSettings" class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg hidden">
        <div class="flex items-center gap-2 mb-3">
          <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span class="font-medium text-blue-700 dark:text-blue-300">定时发布</span>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="admin-form-group mb-0">
            <label for="scheduledDate" class="admin-label">发布日期</label>
            <input 
              type="date" 
              id="scheduledDate" 
              name="scheduledDate"
              class="admin-input"
            />
          </div>
          <div class="admin-form-group mb-0">
            <label for="scheduledTime" class="admin-label">发布时间</label>
            <input 
              type="time" 
              id="scheduledTime" 
              name="scheduledTime"
              class="admin-input"
              value="09:00"
            />
          </div>
        </div>
        <p class="text-xs text-blue-600 dark:text-blue-400 mt-2">
          文章将在指定时间自动发布。请使用本地时间。
        </p>
      </div>
    </div>
    
    <!-- 操作按钮 -->
    <div class="flex items-center gap-4">
      <button type="submit" class="admin-btn admin-btn-primary">
        保存文章
      </button>
      <a href="/admin/articles" class="admin-btn admin-btn-secondary">
        取消
      </a>
    </div>
  </form>
  <!-- 内部链接选择器 Modal -->
  <div id="internal-link-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-lg mx-4 overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700">
        <h3 class="font-semibold text-gray-900 dark:text-white">Insert Internal Link</h3>
        <button id="close-link-modal" type="button" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="p-4">
        <input id="link-search" type="text" placeholder="Search articles by title..." class="admin-input mb-3" />
        <div id="link-article-list" class="max-h-64 overflow-y-auto space-y-0.5"></div>
      </div>
    </div>
  </div>

  <!-- 媒体选择器 Modal -->
  <div id="media-picker-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-2xl mx-4 overflow-hidden flex flex-col max-h-[80vh]">
      <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700 shrink-0">
        <h3 class="font-semibold text-gray-900 dark:text-white">选择图片</h3>
        <button id="close-media-modal" type="button" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="p-4 shrink-0 border-b border-gray-200 dark:border-gray-700">
        <label class="flex items-center gap-3 cursor-pointer border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-3 hover:border-primary-500 transition-colors">
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
          </svg>
          <span class="text-sm text-gray-600 dark:text-gray-400">上传新图片</span>
          <input type="file" id="media-upload-input" accept="image/*" class="hidden" />
        </label>
      </div>
      <div id="media-picker-grid" class="p-4 overflow-y-auto grid grid-cols-3 sm:grid-cols-4 gap-3">
        <p class="col-span-full text-sm text-gray-400 text-center py-4">加载中...</p>
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  .editor-btn {
    @apply p-2 rounded text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors;
  }
</style>

<script>
  // 标题自动生成 slug
  const titleInput = document.getElementById('title') as HTMLInputElement;
  const slugInput = document.getElementById('slug') as HTMLInputElement;
  
  titleInput?.addEventListener('input', () => {
    if (!slugInput.value) {
      slugInput.value = titleInput.value
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');
    }
  });
  
  // 摘要字数统计
  const descInput = document.getElementById('description') as HTMLTextAreaElement;
  const descCount = document.getElementById('description-count');
  
  descInput?.addEventListener('input', () => {
    descCount!.textContent = descInput.value.length.toString();
  });
  
  // 定时发布控制
  const statusSelect = document.getElementById('status') as HTMLSelectElement;
  const scheduleSettings = document.getElementById('scheduleSettings');
  const scheduledDate = document.getElementById('scheduledDate') as HTMLInputElement;
  
  // 设置默认日期为明天
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  scheduledDate!.min = new Date().toISOString().split('T')[0];
  scheduledDate!.value = tomorrow.toISOString().split('T')[0];
  
  statusSelect?.addEventListener('change', () => {
    if (statusSelect.value === 'scheduled') {
      scheduleSettings!.classList.remove('hidden');
    } else {
      scheduleSettings!.classList.add('hidden');
    }
  });
  
  // 编辑器工具栏
  const contentArea = document.getElementById('content') as HTMLTextAreaElement;
  
  document.querySelectorAll('[data-action]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const action = (btn as HTMLElement).getAttribute('data-action');
      const start = contentArea.selectionStart;
      const end = contentArea.selectionEnd;
      const selected = contentArea.value.substring(start, end);
      
      if (action === 'internal-link') {
        // 打开内部链接选择器
        openInternalLinkPicker(start, end, selected);
        return;
      }
      
      if (action === 'image') {
        openMediaPicker('content');
        return;
      }
      
      const actions: Record<string, [string, string]> = {
        bold: ['**', '**'],
        italic: ['*', '*'],
        h2: ['## ', ''],
        h3: ['### ', ''],
        ul: ['- ', ''],
        ol: ['1. ', ''],
        link: ['[', '](url)'],
        image: ['![alt](', ')'],
        code: ['```\n', '\n```'],
      };
      
      if (actions[action!]) {
        const [before, after] = actions[action!];
        contentArea.value = 
          contentArea.value.substring(0, start) + 
          before + selected + after + 
          contentArea.value.substring(end);
        contentArea.focus();
      }
    });
  });
  
  // 内部链接选择器
  let _linkInsertStart = 0;
  let _linkInsertEnd = 0;
  let _linkInsertSelected = '';
  
  function openInternalLinkPicker(start: number, end: number, selected: string) {
    _linkInsertStart = start;
    _linkInsertEnd = end;
    _linkInsertSelected = selected;
    const modal = document.getElementById('internal-link-modal')!;
    modal.classList.remove('hidden');
    const searchInput = document.getElementById('link-search') as HTMLInputElement;
    searchInput.value = '';
    searchInput.focus();
    loadArticles('');
  }
  
  async function loadArticles(query: string) {
    const list = document.getElementById('link-article-list')!;
    list.innerHTML = '<p class="text-sm text-gray-400 p-2">Loading...</p>';
    try {
      const res = await fetch(`/api/articles?q=${encodeURIComponent(query)}&limit=20`);
      const data = await res.json();
      const articles = data.articles || data || [];
      if (articles.length === 0) {
        list.innerHTML = '<p class="text-sm text-gray-400 p-2">No articles found.</p>';
        return;
      }
      list.innerHTML = articles.map((a: any) => `
        <button type="button" class="link-article-item w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm" data-slug="${a.slug}" data-title="${a.title}">
          <span class="font-medium text-gray-900 dark:text-white">${a.title}</span>
          <span class="text-xs text-gray-400 ml-2">/${a.slug}</span>
        </button>
      `).join('');
      
      list.querySelectorAll('.link-article-item').forEach(item => {
        item.addEventListener('click', () => {
          const slug = (item as HTMLElement).dataset.slug!;
          const title = (item as HTMLElement).dataset.title!;
          const linkText = _linkInsertSelected || title;
          const markdown = `[${linkText}](/${slug})`;
          contentArea.value =
            contentArea.value.substring(0, _linkInsertStart) +
            markdown +
            contentArea.value.substring(_linkInsertEnd);
          contentArea.focus();
          document.getElementById('internal-link-modal')!.classList.add('hidden');
        });
      });
    } catch {
      list.innerHTML = '<p class="text-sm text-red-400 p-2">Failed to load articles.</p>';
    }
  }
  
  document.getElementById('link-search')?.addEventListener('input', (e) => {
    loadArticles((e.target as HTMLInputElement).value);
  });
  
  document.getElementById('close-link-modal')?.addEventListener('click', () => {
    document.getElementById('internal-link-modal')!.classList.add('hidden');
  });
  
  document.getElementById('internal-link-modal')?.addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
      (e.currentTarget as HTMLElement).classList.add('hidden');
    }
  });

  // ── 媒体选择器 ──────────────────────────────────────────
  let _mediaPickerMode: 'hero' | 'content' = 'hero';

  async function openMediaPicker(mode: 'hero' | 'content') {
    _mediaPickerMode = mode;
    document.getElementById('media-picker-modal')!.classList.remove('hidden');
    await loadMediaPickerFiles();
  }

  async function loadMediaPickerFiles() {
    const grid = document.getElementById('media-picker-grid')!;
    grid.innerHTML = '<p class="col-span-full text-sm text-gray-400 text-center py-4">加载中...</p>';
    try {
      const res = await fetch('/api/admin/media');
      const data = await res.json();
      const files = (data.files || []).filter((f: any) => f.type === 'image');
      if (files.length === 0) {
        grid.innerHTML = '<p class="col-span-full text-sm text-gray-400 text-center py-4">暂无图片，请先上传</p>';
        return;
      }
      grid.innerHTML = files.map((f: any) => `
        <button type="button" class="media-pick-item group relative aspect-square rounded-lg overflow-hidden border-2 border-transparent hover:border-primary-500 transition-colors" data-url="${f.url}">
          <img src="${f.url}" alt="${f.name}" class="w-full h-full object-cover" loading="lazy" />
          <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
        </button>
      `).join('');
      grid.querySelectorAll('.media-pick-item').forEach(item => {
        item.addEventListener('click', () => {
          const url = (item as HTMLElement).dataset.url!;
          if (_mediaPickerMode === 'hero') {
            const heroInput = document.getElementById('heroImage') as HTMLInputElement;
            heroInput.value = url;
            updateHeroPreview(url);
          } else {
            // 插入到正文光标位置
            const start = contentArea.selectionStart;
            const end = contentArea.selectionEnd;
            const markdown = `![image](${url})`;
            contentArea.value = contentArea.value.substring(0, start) + markdown + contentArea.value.substring(end);
            contentArea.focus();
          }
          document.getElementById('media-picker-modal')!.classList.add('hidden');
        });
      });
    } catch {
      grid.innerHTML = '<p class="col-span-full text-sm text-red-400 text-center py-4">加载失败</p>';
    }
  }

  // 上传新图片
  document.getElementById('media-upload-input')?.addEventListener('change', async (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('file', file);
    try {
      const res = await fetch('/api/admin/media', { method: 'POST', body: formData });
      const data = await res.json();
      if (data.success) await loadMediaPickerFiles();
    } catch { /* ignore */ }
    (e.target as HTMLInputElement).value = '';
  });

  // 封面图按钮
  document.getElementById('hero-media-btn')?.addEventListener('click', () => openMediaPicker('hero'));

  // image 工具栏按钮改为打开媒体选择器
  // (覆盖之前 actions 里的 image 处理，在 data-action 监听里已处理)

  // 封面图预览
  function updateHeroPreview(url: string) {
    const preview = document.getElementById('hero-preview')!;
    const img = document.getElementById('hero-preview-img') as HTMLImageElement;
    if (url) {
      img.src = url;
      preview.classList.remove('hidden');
    } else {
      preview.classList.add('hidden');
    }
  }
  document.getElementById('heroImage')?.addEventListener('input', (e) => {
    updateHeroPreview((e.target as HTMLInputElement).value);
  });

  // 关闭媒体 modal
  document.getElementById('close-media-modal')?.addEventListener('click', () => {
    document.getElementById('media-picker-modal')!.classList.add('hidden');
  });
  document.getElementById('media-picker-modal')?.addEventListener('click', (e) => {
    if (e.target === e.currentTarget) (e.currentTarget as HTMLElement).classList.add('hidden');
  });
  // ────────────────────────────────────────────────────────
  
  // 表单提交处理
  const form = document.querySelector('form[action="/api/admin/articles"]') as HTMLFormElement;
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    const originalText = submitBtn.textContent;
    submitBtn.textContent = '保存中...';
    submitBtn.disabled = true;
    
    try {
      const response = await fetch('/api/admin/articles', {
        method: 'POST',
        body: formData,
        credentials: 'include',
      });
      
      const result = await response.json();
      
      if (result.success && result.redirect) {
        window.location.href = result.redirect;
      } else if (result.error) {
        alert(result.message || '保存失败：' + result.error);
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      } else {
        alert('保存失败，请重试。');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    } catch (error) {
      console.error('Submit error:', error);
      alert('保存失败，请重试。');
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  });
</script>